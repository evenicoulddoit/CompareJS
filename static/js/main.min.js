'use strict';(function(){window.specificity=function(k){var p=k,v={a:0,b:0,c:0},m=[];k=function(A,k){var n,a,c,l,r,f;if(A.test(p))for(n=p.match(A),a=0,c=n.length;a<c;a+=1)v[k]+=1,l=n[a],r=p.indexOf(l),f=l.length,m.push({selector:l,type:k,index:r,length:f}),p=p.replace(l,Array(f+1).join(" "))};(function(){var k=/:not\(([^\)]*)\)/g;k.test(p)&&(p=p.replace(k,"     $1 "))})();(function(){var k=/{[^]*/gm,m,n,a;if(k.test(p))for(k=p.match(k),m=0,n=k.length;m<n;m+=1)a=k[m],p=p.replace(a,Array(a.length+1).join(" "))})();
k(/(\[[^\]]+\])/g,"b");k(/(#[^\s\+>~\.\[:]+)/g,"a");k(/(\.[^\s\+>~\.\[:]+)/g,"b");k(/(::[^\s\+>~\.\[:]+|:first-line|:first-letter|:before|:after)/gi,"c");k(/(:[\w-]+\([^\)]*\))/gi,"b");k(/(:[^\s\+>~\.\[:]+)/g,"b");p=p.replace(/[\*\s\+>~]/g," ");p=p.replace(/[#\.]/g," ");k(/([^\s\+>~\.\[:]+)/g,"c");m.sort(function(k,m){return k.index-m.index});return parseInt([v.a,v.b,v.c].join(""),10)}})(window);(function(k,p,v){function m(e){return function(b){return 0===b.indexOf(e)}}function A(e){var b={},q=e.ownerDocument.styleSheets,s,h,d,g,a,c,k,l;for(c=0;c<q.length;c++)if(s=q[c],s=s.cssRules)for(k=0;k<s.length;k++)if(h=s[k],1===h.type){d=h.selectorText.split(",");a=[];for(l=0;l<d.length;l++){g=d[c];var f;a:{f=e;for(var m=g,t=void 0,r=void 0,u=["matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector"],t=0;t<u.length;t++)if(r=u[t],r in f){f=f[r](m);break a}f=void 0}f&&a.push(p(g))}if(a.length)for(d=
Math.max.apply(Math,a),g=b,h=h.style,a=h.length,f=m=l=void 0,f=0;f<a;f++)m=l=h[f],t=m.indexOf("-value"),-1!==t&&t===m.length-6&&(m=m.substring(0,t)),m in g&&d<g[m].specificity||(g[m]={specificity:d,value:h.getPropertyValue(l)})}return b}function C(e,b){var q=b.length,s,a;for(a=0;a<q;a++)if(0===a)s=e[b[a]];else if(e[b[a]]!==s)return!1;return!0}function n(e,b){var q=b.length,a;for(a=0;a<q;a++)delete e[b[a]]}function a(e){var b,q,a;["a","b"].forEach(function(h){["margin","padding"].forEach(function(d){b=
e[h];q=!1;a=Object.keys(b).filter(function(b){return 0===b.indexOf(d+"-")});4==a.length&&(C(b,a)?(q=!0,b[d]=b[a[0]]):C(b,[d+"-left",d+"-right"])&&(q=!0,C(b,[d+"-top",d+"-bottom"])?b[d]=b[d+"-top"]+" "+b[d+"-left"]:b[d]=b[d+"-top"]+" "+b[d+"-left"]+" "+b[d+"-bottom"]),q&&n(b,[d+"-top",d+"-right",d+"-bottom",d+"-left"]))})})}function c(e){var b;if(!e.last)return e.last=e.stop,c(e);b=l(e);return null!==b&&e.exclude&&r(b,e.exclude)?(e.no_down=!0,e.last=b,c(e)):b}function l(e){var b=e.last,q;if(!e.no_down&&
(q=(q=e.all)&&b.childNodes.length?b.childNodes[0]:!q&&b.children.length?b.children[0]:null,q))return q;e.no_down=!1;if(q=e.all?b.nextSibling:b.nextElementSibling)return q;for(;b!=e.stop;){b=b.parentNode;if(b==e.stop)return null;if(q=e.all?b.nextSibling:b.nextElementSibling)return q}}function r(e,b){var q=b.length,a,h,d;h=0;a:for(;h<q;h++)if(a=b[h],!a.hasOwnProperty("tag")||a.tag===e.tagName){if(a.hasOwnProperty("attributes"))for(d in a.attributes)if(a.attributes[d]!==e.getAttribute(d))continue a;
return a}return!1}function f(e){return{1:"element",3:"text"}[e.nodeType.toString()]}function B(e){var b=e.tagName.toLowerCase(),a;a=e.attributes.length;var c=[],h="",d,g;for(g=0;g<a;g++)c.push(e.attributes[g].name);c.sort();for(g=0;g<a;g++)d=c[g],h+=" "+d+'="'+e.attributes.getNamedItem(d).value+'"';a=h;c=e.childNodes.length;h=[];for(g=0;g<c;g++)d=e.childNodes[g],"text"==f(d)&&h.push(d.nodeValue);c=h.join(" ").replace(D," ").trim();e._sig=e._originalSig="<"+b+a+">"+c+"</"+b+">";e._attrStr=a;e._textStr=
c;return e._sig}function w(e){this.name="ReachedLimitError";this.message=e;this.stack=Error().stack}function y(){this.a=[];this.b=[]}function z(e){if(!e.a||!e.b)throw new TypeError("You must supply both DOM tree A and B");this.opts=e;this.a=e.a;this.b=e.b;this.MAX_DIFFERENCES=e.max_differences||25;this.aStyleSheets=this.a.ownerDocument.styleSheets;this.bStyleSheets=this.b.ownerDocument.styleSheets;this.differenceCount=0;this.differences={tag:[],attr:[],removed:[],added:[],text:[],moved:[],space:[],
style:[]};this.parse_exclusions();this.signatureMap={};try{this._parse_elements(),this._process_imbalances(),this._find_movements()}catch(b){if(!(b instanceof w))throw b;}}var E=/^\s+/,F=/\s+$/,D=/\s{2,}/g;w.prototype=Object.create(Error.prototype);y.prototype.push=function(e,b){this[e].push(b)};z.prototype={parse_exclusions:function(){var e,b,a;this.exclude_completely=[];this.exclude_changes=[];if(this.opts.exclude instanceof Array)for(e=this.opts.exclude.length,b=0;b<e;b++)if(a=this.opts.exclude[b],
"string"===typeof a.tag||a.attributes instanceof Array)"string"===typeof a.tag&&(a.tag=a.tag.toUpperCase()),a.hasOwnProperty("method")&&"all"!==a.method?this.exclude_changes.push(a):this.exclude_completely.push(a)},_parse_elements:function(){var e,b,a;["a","b"].forEach(function(s){a=0;e=this["elems"+s.toUpperCase()]=[];for(b=c({stop:this[s],exclude:this.exclude_completely});b;)B(b),this.add_to_map(b,s),e.push(b),b._index=a,b=c({last:b,stop:this[s],exclude:this.exclude_completely}),a++;this["total"+
s.toUpperCase()]=a},this)},_find_movements:function(){for(var a={},b={},c=0,s=0,h,d,g,f;;){h=this.elemsA[c];d=this.elemsB[s];if(!h&&!d)break;g=h?h._sig:"";f=d?d._sig:"";g==f?(c++,s++):g in a||f in b?(g in a&&(this._difference("moved",h,a[g]),delete a[g],c++),f in b&&(this._difference("moved",b[f],d),delete b[f],s++)):(a[f]=d,b[g]=h,c++,s++)}},add_to_map:function(a,b){var c=B(a);c in this.signatureMap||(this.signatureMap[c]=new y);this.signatureMap[c].push(b,a)},_process_imbalances:function(){var a=
[],b=[],c,f,h;for(c in this.signatureMap)f=this.signatureMap[c],f.a.length!=f.b.length&&(f.a.length&&Array.prototype.push.apply(a,f.a),f.b.length&&Array.prototype.push.apply(b,f.b));for(f=0;f<a.length;f++)c=a[f],(h=this._find_match(c,b))?(-1!==["attr","tag","text"].indexOf(h.type)&&this.should_report_change(c,h)&&this._difference(h.type,c,h.elem),h.elem._sig=c._sig,b.splice(b.indexOf(h.elem),1)):this._difference("removed",c);for(f=0;f<b.length;f++)this._difference("added",b[f])},_find_match:function(a,
b){var c=[],f=!1,h,d,g,l,k;for(d=0;d<b.length;d++)h=b[d],g=a.tagName===h.tagName,l=a._attrStr===h._attrStr,k=a._textStr===h._textStr,2<=g+l+k&&(h={elem:h},g&&l&&k?(h.type="identical",f=!0):(g||(h.type="tag"),l||(h.type="attr"),k||(h.type="text")),c.push(h));f&&(c=c.filter(function(a){return"identical"==a.type}));return 0<c.length?c.sort(function(b,d){var c=Math.abs(b.elem._index-a._index),f=Math.abs(d.elem._index-a._index);return c<f?-1:f<c?1:0})[0]:null},should_report_change:function(a,b){var c=
r(a,this.exclude_changes);if(!c||!c.method.hasOwnProperty(b.type))return!0;if("attr"==b.type)return!this.attr_changes_match(a,b.elem,c.method.attr)},attr_changes_match:function(a,b,c){var f=[],h=a.attributes.length,d,g;for(g=0;g<h;g++)if(d=a.attributes[g].name,f.push(d),a.getAttribute(d)!=b.getAttribute(d)&&-1==c.indexOf(d))return!1;h=b.attributes.length;for(g=0;g<h;g++)if(d=b.attributes[g].name,-1==f.indexOf(d)&&-1==c.indexOf(d))return!1;return!0},find_visual_differences:function(e,b){var l=0,s=
0,h=0,d,g,r,p,B;void 0===e&&(e=c({stop:this.a,all:!0,exclude:this.exclude_completely}),b=c({stop:this.b,all:!0,exclude:this.exclude_completely}));for(;null!==e&&null!==b&&25>l;){d=e&&f(e);g=b&&f(b);r=[d,g].sort();p=B=!0;"element"==d&&(s=e._index);"element"==g&&(h=b._index);if(d!==g)if("element"==r[0]&&"text"==r[1])"element"==d?p=!1:B=!1;else{if(-1!=r.indexOf("element")||-1!=r.indexOf("text"))"element"==d||"text"==d?p=!1:B=!1}else if("element"==d){d=e;g=b;var n=d,x=g;r=k.getComputedStyle(n);for(var y=
k.getComputedStyle(x),n=n.ownerDocument.URL.split("/").slice(0,3).join("/"),x=x.ownerDocument.URL.split("/").slice(0,3).join("/"),t=[],v=r.length,u=void 0,w=void 0,w=0;w<v;w++)u=r[w],r.getPropertyValue(u).replace(n,"")!=y.getPropertyValue(u).replace(x,"")&&t.push(u);r=t;y={a:{},b:{}};n=0;x=t=void 0;if(r.length){d=A(d);g=A(g);t={};v=[];w=u=void 0;for(u in d)w=(g[u]||{}).value,d[u].value!=w&&(t[u]=[d[u].value,w]),v.push(u);for(u in g)-1==v.indexOf(u)&&(t[u]=[void 0,g[u].value]);for(x in t)0<r.filter(m(x)).length&&
(void 0!==t[x][0]&&(y.a[x]=t[x][0]),void 0!==t[x][1]&&(y.b[x]=t[x][1]),n++)}a(y);d=0!==n?y:null;null!==d&&(g=this.already_reported_style_change(e,d),null===g?(e._styleAffects=1,e._styleDiff=d,this._difference("style",e,b)):g._styleAffects++)}else{if(d="text"==d&&e.nodeValue!==b.nodeValue)d=b,d=e.nodeValue.replace(D,"")===d.nodeValue.replace(D,"");d&&(d=e,g=b,parentStyle=k.getComputedStyle((d||g).parentNode),parentBlock="block"===parentStyle.getPropertyValue("display"),parentFloat="none"!==parentStyle.getPropertyValue("float"),
parentSpaceMatters=parentBlock||parentFloat,textA=null!==d?d.nodeValue:"",textB=null!==g?g.nodeValue:"",back,forward,d=!1);d&&this._difference("space",e,b)}p&&(e=c({last:e,stop:this.a,all:!0,exclude:this.exclude_completely}));B&&(b=c({last:b,stop:this.b,all:!0,exclude:this.exclude_completely}));l++}e||b?(l=Math.round(50*(s/this.totalA+h/this.totalB)),l=Math.min(99,l)):l=100;return{a:e,b:b,progress:l}},already_reported_style_change:function(a,b){var c=this.differences.style,f=c.length,h,d;for(h=0;h<
f;h++)if(d=c[h][0],a._sig===d._sig&&JSON.stringify(b)===JSON.stringify(d._styleDiff))return d;return null},_different_spaces:function(a,b){var c=null===a.match(E),f=null===b.match(E),h=null===a.match(F),d=null===b.match(F),g=[];c!=f&&g.push("left");h!=d&&g.push("right");return g},_difference:function(a,b,c){this.differenceCount++;this.differences[a].push([b,c]);if(this.differenceCount>=this.MAX_DIFFERENCES)throw this.stopped_at_max=!0,new w("Max number of differences reached");}};k.Compare=z})(window,
window.specificity,window.console.log.bind(window.console));(function(k,p,v){function m(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function A(a){var c=1!=a.indexOf("?")?"?":"&";return a+c+"_cachebust="+Date.now()}try{document.domain="compare.js"}catch(C){v("FAILed to set document.domain to compare.js - make sure that you've your ServerName is correctly set to compare.js")}var n={init:function(){this.responseActive=!1;this.frameA=this.make_iframe();this.frameB=this.make_iframe();this.parse_dom();
this.settings={};this.events()},parse_dom:function(){this.wrapper=document.getElementById("wrapper");this.inA=document.getElementById("page-a");this.inB=document.getElementById("page-b");this.startOverBtn=document.getElementById("do-start-over");this.inBtn=document.getElementById("do-compare");this.settingsDom={toggle:document.getElementById("settings-toggle"),cacheBust:document.getElementById("settings-cache-bust"),exclude:document.getElementById("settings-exclude")};this.response=document.getElementById("response");
this.responseIcon=document.getElementById("response-icon");this.responseSummary=document.getElementById("response-summary");this.responseDetails=document.getElementById("response-details")},process_settings:function(){var a=this.settingsDom.exclude.value.trim();this.settings.cacheBust="yes"===this.settingsDom.cacheBust.value;if(a)try{this.settings.exclude=JSON.parse(a)}catch(c){if(c instanceof SyntaxError)throw this.compare_failed("Failed to parse exclusions JSON block"),c;}else this.settings.exclude=
[]},process_start_over:function(){this.process_comparison(!0)},process_comparison:function(a){var c;""!==this.inA.value&&""!==this.inB.value&&(this.process_settings(),this.toggle_settings(!1),this.inBtn.className="",this.wrapper.setAttribute("class","loading"),this.remove_response(),!0===a?(this.report_progress("Loading pages"),a=this.get_contents(this.frameA,this.inA.value),c=this.get_contents(this.frameB,this.inB.value),k.all([a,c]).then(this.do_compare.bind(this,!0),this.compare_failed.bind(this)).catch(this.compare_failed.bind(this))):
this.do_compare(!1,[this.frameA.contentDocument.body,this.frameB.contentDocument.body]))},response_active:function(){this.responseActive=!0;this.wrapper.setAttribute("class","with-response")},response_inactive:function(){this.responseActive=!1;this.wrapper.removeAttribute("class")},do_compare:function(a,c){var l=this,k=a?2E3:1E3,f;this.report_progress("Calculating DOM differences");setTimeout(function(){try{f=new p({a:c[0],b:c[1],exclude:l.settings.exclude}),l.compare=f}catch(a){return l.compare_failed(a)}if(f.stopped_at_max)return l.response_active(),
l.differences_true(f.differences);l._async_visual()},k)},_async_visual:function(a){var c=this,l,k;void 0===a&&(a={progress:0});if(100>a.progress)setTimeout(function(){try{a=c.compare.find_visual_differences(a.a,a.b),c.report_progress("Calculating visual differences &mdash; "+a.progress+"% complete"),c._async_visual(a)}catch(f){return c.compare_failed(f)}},0);else{l=c.compare.differences;c.response_active();for(k in l)if(0!==l[k].length)return c.differences_true(l);return c.differences_false()}},remove_response:function(){this.response.removeAttribute("class");
this.responseIcon.removeAttribute("class");this.responseSummary.innerHTML="";this.responseDetails.innerHTML=""},differences_true:function(a){var c=0,l=document.createElement("ul"),k,f,m,p,n;for(k in a)for(f=a[k],p=f.length,c+=f.length,n=0;n<p;n++)m=document.createElement("li"),m.innerHTML=this.report_difference(k,f[n]),l.appendChild(m);this.compare.stopped_at_max&&(c+="+");this.response.setAttribute("class","errors");this.responseIcon.setAttribute("class","issues fa fa-exclamation-circle");this.responseSummary.innerHTML=
c+" Difference(s) Found";this.responseDetails.appendChild(l)},differences_false:function(){this.response.setAttribute("class","identical");this.responseIcon.setAttribute("class","fa fa-check-circle");this.responseSummary.innerHTML="Pages are identical";this.responseDetails.innerHTML="We've checked the pages for both DOM and visual differences, and we couldn't find any!"},report_progress:function(a){this.response.setAttribute("class","loading");this.responseIcon.setAttribute("class","fa fa-spin fa-spinner");
this.responseSummary.innerHTML=a;this.responseDetails.innerHTML=""},report_difference:function(a,c){switch(a){case "tag":return'Tag change<code class="a">'+m(c[0]._originalSig)+'</code><code class="b">'+m(c[1]._originalSig)+"</code>";case "attr":return'Attribute change<code class="a">'+m(c[0]._originalSig)+'</code><code class="b">'+m(c[1]._originalSig)+"</code>";case "removed":return'Element removed<code class="a removed">'+m(c[0]._originalSig)+"</code>";case "added":return'Element added<code class="b">'+
m(c[0]._originalSig)+"</code>";case "text":return'Text changed<code class="a">'+m(c[0]._originalSig)+'</code><code class="b">'+m(c[1]._originalSig)+"</code>";case "moved":return'Element Moved<code class="a">'+m(c[0]._originalSig)+"</code>";case "style":var k=c[0]._styleDiff,p=c[0]._styleAffects,f="",n="",w=Object.keys(k.a).length,v=Object.keys(k.b).length,z;for(z in k.a)1<w&&(f+="\n  "),f+=z+": "+k.a[z]+"; ";for(z in k.b)1<v&&(n+="\n  "),n+=z+": "+k.b[z]+"; ";1<w&&(f+="\n");1<v&&(n+="\n");return"Style change affecting "+
p+' element(s)<code class="c">'+m(c[0]._originalSig)+'</code><code class="a">{ '+f+'}</code><code class="b">{ '+n+"}</code>"}},compare_failed:function(a){this.wrapper.setAttribute("class","with-response");this.remove_response();this.response_active();if("object"===typeof a&&"ReachedLimitError"===a.name)return this.differences_true(this.compare.differences);v("Error: ",a);this.response.setAttribute("class","errors");this.responseIcon.setAttribute("class","issues fa fa-exclamation-circle");this.responseSummary.innerHTML=
"Comparison failed";this.responseDetails.innerHTML="string"===typeof a?a:void 0!==a.error&&"SecurityError"===a.error.name?"Failed to access <em>"+a.url+"</em> due to cross-origin restrictions":"An unknown error was raised"},make_iframe:function(){var a=document.createElement("iframe");document.getElementById("iframes").appendChild(a);return a},get_contents:function(a,c){a.src=this.settings.cacheBust?A(c):c;a.removeEventListener("load",a._loadEvent);return new k(function(k,m){a._loadEvent=function(){try{k(a.contentDocument.body)}catch(f){m({error:f,
url:c})}};a.addEventListener("load",a._loadEvent)})},process_if_enter:function(a){13==a.keyCode&&this.process_comparison(!0)},toggle_settings:function(a){this.settingsDom.toggle.className=!0===a||!1!==a&&""===this.settingsDom.toggle.className?this.settingsDom.toggle.className+"open":""},events:function(){this.inBtn.addEventListener("click",this.process_comparison.bind(this));this.startOverBtn.addEventListener("click",this.process_start_over.bind(this));this.inA.addEventListener("keypress",this.process_if_enter.bind(this));
this.inB.addEventListener("keypress",this.process_if_enter.bind(this));this.settingsDom.toggle.addEventListener("click",this.toggle_settings.bind(this))}};document.addEventListener("DOMContentLoaded",n.init.bind(n))})(window.Promise,window.Compare,window.console.log.bind(window.console));
