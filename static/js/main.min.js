'use strict';(function(q,m){function n(a,e){if(!a)return e.children.length?e.children[0]:null;if(a.children.length)return a.children.length?a.children[0]:null;if(a.nextElementSibling)return a.nextElementSibling;for(;a!=e;){a=a.parentNode;if(a==e)return null;if(a.nextElementSibling)return a.nextElementSibling}}function f(){this.a=[];this.b=[]}function p(a,e){this.a=a;this.b=e;this.differences={elements:{retag:[],reattribute:[],removed:[],added:[],text:[],moved:[]},visual:{}};m("Loading...",this.a,
this.b);this.signatureMap={};this._parse_elements();this._process_imbalances();this._find_movements();m("Done loading",a,e)}var d=/^\s+/,b=/\s+$/,r=/\s{2,}/g;m=function(){};f.prototype.push=function(a,e){this[a].push(e)};p.prototype={_parse_elements:function(){var a=n(this.a,this.a),e=n(this.b,this.b);for(this.elemsA=[];a;)this.add_to_map(a,"a"),this.elemsA.push(a),a=n(a,this.a);for(this.elemsB=[];e;)this.add_to_map(e,"b"),this.elemsB.push(e),e=n(e,this.b)},_find_movements:function(){for(var a={},
e={},b=0,k=0,c,g,d,h;;){c=this.elemsA[b];g=this.elemsB[k];m(c,g);if(!c&&!g)break;d=c?c._sig:"";h=g?g._sig:"";d==h?(m("    Identical"),b++,k++):d in a||h in e?(d in a&&(this._difference("elements","moved",c,a[d]),delete a[d],b++),h in e&&(this._difference("elements","moved",e[h],g),delete e[h],k++)):(a[h]=g,e[d]=c,b++,k++)}},add_to_map:function(a,e){var d;d=a.tagName.toLowerCase();var k;k=a.attributes.length;var c=[],b="",l,h;for(h=0;h<k;h++)c.push(a.attributes[h].name);c.sort();for(h=0;h<k;h++)l=
c[h],b+=" "+l+'="'+a.attributes.getNamedItem(l).value+'"';k=b;c=a.childNodes.length;b=[];for(h=0;h<c;h++)l=a.childNodes[h],"text"=={1:"element",3:"text"}[l.nodeType.toString()]&&b.push(l.nodeValue);c=b.join(" ").replace(r," ").trim();a._sig=a._originalSig="<"+d+k+">"+c+"</"+d+">";a._attrStr=k;a._textStr=c;d=a._sig;d in this.signatureMap||(this.signatureMap[d]=new f);this.signatureMap[d].push(e,a)},_process_imbalances:function(){var a=[],e=[],d=0,b,c,g;for(b in this.signatureMap)c=this.signatureMap[b],
c.a.length!=c.b.length&&(c.a.length&&Array.prototype.push.apply(a,c.a),c.b.length&&Array.prototype.push.apply(e,c.b));for(c=0;c<a.length;c++)b=a[c],(g=this._find_match(b,e,c-d))?("attr"===g.type?this._difference("elements","reattribute",b,g.elem):"tag"===g.type?this._difference("elements","retag",b,g.elem):"text"===g.type&&this._difference("elements","text",b,g.elem),g.elem._sig=b._sig,e.splice(e.indexOf(g.elem),1),d++):this._difference("elements","removed",b);for(c=0;c<e.length;c++)this._difference("elements",
"added",e[c])},_find_match:function(a,b,d){var k=[],c,g,l,h,f;for(g=0;g<b.length;g++)c=b[g],l=a.tagName===c.tagName,h=a._attrStr===c._attrStr,f=a._textStr===c._textStr,2<=l+h+f&&(c={i:g,elem:c},l&&h&&f?c.type="identical":(l||(c.type="tag"),h||(c.type="attr"),f||(c.type="text")),k.push(c));console.log("Looking for matches for "+a," - index "+d);console.log("    ",k);return 0<k.length?k.sort(function(a,b){var c=Math.abs(a.i-d),e=Math.abs(b.i-d);return c<e?-1:e<c?1:0})[0]:null},_different_spaces:function(a,
e){var f=null===a.match(d),k=null===e.match(d),c=null===a.match(b),g=null===e.match(b),l=[];f!=k&&l.push("left");c!=g&&l.push("right");return l},_difference:function(a,b,d,k){m(arguments);this.differences[a][b].push([d,k])}};q.Compare=p})(window,window.console.log.bind(window.console));(function(q,m,n){function f(d){return String(d).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}var p={init:function(){this.responseActive=!1;this.parse_dom();this.events()},parse_dom:function(){this.wrapper=document.getElementById("wrapper");this.inA=document.getElementById("page-a");this.inB=document.getElementById("page-b");this.inBtn=document.getElementById("do-compare");this.loading=document.getElementById("loading");this.response=document.getElementById("response");
this.responseIcon=document.getElementById("response-icon");this.responseSummary=document.getElementById("response-summary");this.responseDetails=document.getElementById("response-details")},process_comparison:function(){if(""!==this.inA.value&&""!==this.inB.value){var d=this.get_contents(this.inA.value),b=this.get_contents(this.inB.value);this.remove_response();this.loading.setAttribute("class","visible");q.all([d,b]).then(this.do_compare.bind(this),this.compare_failed.bind(this))}},response_active:function(){this.responseActive=
!0;this.wrapper.setAttribute("class","with-response")},response_inactive:function(){this.responseActive=!1;this.wrapper.removeAttribute("class")},loading_finished:function(){this.loading.removeAttribute("class")},do_compare:function(d){var b=(new m(d[0],d[1])).differences,f;n(d[0],d[1],b);this.loading_finished();this.response_active();for(f in b.elements)if(0!==b.elements[f].length){this.differences_dom(b.elements);return}this.differences_none()},remove_response:function(){this.response.removeAttribute("class");
this.responseIcon.removeAttribute("class");this.responseSummary.innerHTML="";this.responseDetails.innerHTML=""},differences_dom:function(d){var b=0,f=document.createElement("ul"),a,e,m,k,c;for(a in d)for(e=d[a],k=e.length,b+=e.length,c=0;c<k;c++)m=document.createElement("li"),m.innerHTML=this.report_difference(a,e[c]),f.appendChild(m);this.response.setAttribute("class","errors");this.responseIcon.setAttribute("class","issues fa fa-exclamation-circle");this.responseSummary.innerHTML=b+" DOM Difference(s) Found";
this.responseDetails.appendChild(f)},differences_none:function(){this.response.setAttribute("class","identical");this.responseIcon.setAttribute("class","fa fa-check-circle");this.responseSummary.innerHTML="Pages are identical";this.responseDetails.innerHTML="We've checked the pages for both DOM and visual differences, and we couldn't find any!"},report_difference:function(d,b){switch(d){case "retag":return"You changed a tag...";case "reattribute":return'Attribute change<code class="a">'+f(b[0]._originalSig)+
'</code><code class="b">'+f(b[1]._originalSig)+"</code>";case "removed":return'Element removed<code class="a removed">'+f(b[0]._originalSig)+"</code>";case "added":return'Element added<code class="b">'+f(b[0]._originalSig)+"</code>";case "text":return'Text changed<code class="a">'+f(b[0]._originalSig)+'</code><code class="b">'+f(b[1]._originalSig)+"</code>";case "moved":return'You moved elements around<code class="a">'+f(b[0]._originalSig)+"</code>"}},compare_failed:function(d){this.loading_finished();
this.remove_response();this.response_active();this.response.setAttribute("class","errors");this.responseIcon.setAttribute("class","issues fa fa-exclamation-circle");this.responseSummary.innerHTML="Comparison failed";this.responseDetails.innerHTML="SecurityError"===d.error.name?"Failed to access <em>"+d.url+"</em> due to cross-origin restrictions":"An unknown error was raised whilst trying to load "+d.url},get_contents:function(d){var b=document.createElement("iframe");b.src=d;return new q(function(f,
a){document.body.appendChild(b);b.addEventListener("load",function(){try{f(b.contentDocument.body)}catch(e){a({error:e,url:d})}finally{b.remove()}})})},process_if_enter:function(d){13==d.keyCode&&this.process_comparison()},events:function(){this.inBtn.addEventListener("click",this.process_comparison.bind(this));this.inA.addEventListener("keypress",this.process_if_enter.bind(this));this.inB.addEventListener("keypress",this.process_if_enter.bind(this))}};document.addEventListener("DOMContentLoaded",
p.init.bind(p))})(window.Promise,window.Compare,window.console.log.bind(window.console));
