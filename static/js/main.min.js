'use strict';(function(){window.specificity=function(l){var n=l,x={a:0,b:0,c:0},z=[];l=function(p,l){var s,q,a,d,g,r;if(p.test(n))for(s=n.match(p),q=0,a=s.length;q<a;q+=1)x[l]+=1,d=s[q],g=n.indexOf(d),r=d.length,z.push({selector:d,type:l,index:g,length:r}),n=n.replace(d,Array(r+1).join(" "))};(function(){var p=/:not\(([^\)]*)\)/g;p.test(n)&&(n=n.replace(p,"     $1 "))})();(function(){var p=/{[^]*/gm,l,s,q;if(p.test(n))for(p=n.match(p),l=0,s=p.length;l<s;l+=1)q=p[l],n=n.replace(q,Array(q.length+1).join(" "))})();
l(/(\[[^\]]+\])/g,"b");l(/(#[^\s\+>~\.\[:]+)/g,"a");l(/(\.[^\s\+>~\.\[:]+)/g,"b");l(/(::[^\s\+>~\.\[:]+|:first-line|:first-letter|:before|:after)/gi,"c");l(/(:[\w-]+\([^\)]*\))/gi,"b");l(/(:[^\s\+>~\.\[:]+)/g,"b");n=n.replace(/[\*\s\+>~]/g," ");n=n.replace(/[#\.]/g," ");l(/([^\s\+>~\.\[:]+)/g,"c");z.sort(function(l,n){return l.index-n.index});return parseInt([x.a,x.b,x.c].join(""),10)}})(window);(function(l,n,x){function z(b){return function(c){return 0===c.indexOf(b)}}function p(b){var c={},k=b.ownerDocument.styleSheets,m,f,e,A,a,d,l,g,t;for(l=0;l<k.length;l++)if(m=k[l],m=m.cssRules)for(g=0;g<m.length;g++)if(f=m[g],1===f.type){e=f.selectorText.split(H).filter(B);a=e.length;d=[];for(t=0;t<a;t++){A=e[t];try{var p;a:{for(var h=b,r=A,u=void 0,y=void 0,q=["matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector"],u=0;u<q.length;u++)if(y=q[u],y in h){p=h[y](r);break a}p=void 0}if(p){d.push(n(A));
break}}catch(s){if(!(s instanceof SyntaxError))throw s;}}if(d.length)for(e=Math.max.apply(Math,d),A=c,f=f.style,a=f.length,t=h=d=void 0,t=0;t<a;t++)h=d=f[t],r=h.indexOf("-value"),-1!==r&&r===h.length-6&&(h=h.substring(0,r)),h in A&&e<A[h].specificity||(A[h]={specificity:e,value:f.getPropertyValue(d)})}return c}function B(b){return""!==b.trim()}function s(b,c){var k=c.length,m,f;for(f=0;f<k;f++)if(0===f)m=b[c[f]];else if(b[c[f]]!==m)return!1;return!0}function q(b,c){var k=c.length,m;for(m=0;m<k;m++)delete b[c[m]]}
function a(b){var c,k,m;["a","b"].forEach(function(f){["margin","padding"].forEach(function(e){c=b[f];k=!1;m=Object.keys(c).filter(function(b){return 0===b.indexOf(e+"-")});4==m.length&&(s(c,m)?(k=!0,c[e]=c[m[0]]):s(c,[e+"-left",e+"-right"])&&(k=!0,s(c,[e+"-top",e+"-bottom"])?c[e]=c[e+"-top"]+" "+c[e+"-left"]:c[e]=c[e+"-top"]+" "+c[e+"-left"]+" "+c[e+"-bottom"]),k&&q(c,[e+"-top",e+"-right",e+"-bottom",e+"-left"]))})})}function d(b){var c;if(!b.last)return b.last=b.stop,d(b);c=g(b);return null!==c&&
b.exclude&&r(c,b.exclude)?(b.no_down=!0,b.last=c,d(b)):c}function g(b){var c=b.last,k;if(!b.no_down&&(k=(k=b.all)&&c.childNodes.length?c.childNodes[0]:!k&&c.children.length?c.children[0]:null,k))return k;b.no_down=!1;if(k=b.all?c.nextSibling:c.nextElementSibling)return k;for(;c!=b.stop;){c=c.parentNode;if(c==b.stop)return null;if(k=b.all?c.nextSibling:c.nextElementSibling)return k}}function r(b,c){var k=c.length,m,f,e;f=0;a:for(;f<k;f++)if(m=c[f],!m.hasOwnProperty("tag")||m.tag===b.tagName){if(m.hasOwnProperty("attributes"))for(e in m.attributes)if(m.attributes[e]!==
b.getAttribute(e))continue a;return m}return!1}function h(b){return{1:"element",3:"text"}[b.nodeType.toString()]}function y(b){var c=b.tagName.toLowerCase(),k;k=b.attributes.length;var m=[],f="",e,a;for(a=0;a<k;a++)m.push(b.attributes[a].name);m.sort();for(a=0;a<k;a++)e=m[a],f+=" "+e+'="'+b.attributes.getNamedItem(e).value+'"';k=f;m=b.childNodes.length;f=[];for(a=0;a<m;a++)e=b.childNodes[a],"text"==h(e)&&f.push(e.nodeValue);m=f.join(" ").replace(C," ").trim();f="<"+c+k+">";b._sig=b._originalSig=f+
m+"</"+c+">";b._tagSig=f;b._attrStr=k;b._textStr=m;return b._sig}function D(b,c){var k=c.exec(b),m,a;if(null===k)return b;k.shift();m=k.length;for(a=0;a<m;a++)b=b.replace(k[a],"");return b}function w(b){this.name="ReachedLimitError";this.message=b;this.stack=Error().stack}function v(){this.a=[];this.b=[]}function E(b){if(!b.a||!b.b)throw new TypeError("You must supply both DOM tree A and B");this.opts=b;this.a=b.a;this.b=b.b;this.MAX_DIFFERENCES=b.max_differences||25;this.aStyleSheets=this.a.ownerDocument.styleSheets;
this.bStyleSheets=this.b.ownerDocument.styleSheets;this.differenceCount=0;this.differences={tag:[],attr:[],removed:[],added:[],text:[],moved:[],space:[],style:[]};this.parse_exclusions();this.signatureMap={};try{this._parse_elements(),this._process_imbalances(),this._find_movements()}catch(c){if(!(c instanceof w))throw c;}}var F=/^\s+/,G=/\s+$/,C=/\s{2,}/g,H=/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/g;w.prototype=Object.create(Error.prototype);v.prototype.push=function(b,c){this[b].push(c)};E.prototype=
{parse_exclusions:function(){var b,c,k,a,f;this.exclude_completely=[];this.exclude_changes=[];if(this.opts.exclude instanceof Array)for(b=this.opts.exclude.length,c=0;c<b;c++)if(k=this.opts.exclude[c],"string"===typeof k.tag||k.attributes instanceof Array)if("string"===typeof k.tag&&(k.tag=k.tag.toUpperCase()),k.hasOwnProperty("method")&&"all"!==k.method){a=k.method.attr;if("object"==typeof a)for(f in a)if("*"!==a[f])try{a[f]=new RegExp(a[f],"i")}catch(e){throw new SyntaxError("Failed to parse exception RegExp: "+
a[f]);}this.exclude_changes.push(k)}else this.exclude_completely.push(k)},_parse_elements:function(){var b,c,k;["a","b"].forEach(function(a){k=0;b=this["elems"+a.toUpperCase()]=[];for(c=d({stop:this[a],exclude:this.exclude_completely});c;)y(c),this.add_to_map(c,a),b.push(c),c._index=k,c=d({last:c,stop:this[a],exclude:this.exclude_completely}),k++;this["total"+a.toUpperCase()]=k},this)},_find_movements:function(){for(var b={},c={},a=0,m=0,f,e,d,h;;){f=this.elemsA[a];e=this.elemsB[m];if(!f&&!e)break;
d=f?f._sig:"";h=e?e._sig:"";d==h?(a++,m++):d in b||h in c?(d in b&&(this._difference("moved",f,b[d]),delete b[d],a++),h in c&&(this._difference("moved",c[h],e),delete c[h],m++)):(b[h]=e,c[d]=f,a++,m++)}},add_to_map:function(b,c){var a=y(b);a in this.signatureMap||(this.signatureMap[a]=new v);this.signatureMap[a].push(c,b)},_process_imbalances:function(){var b=[],c=[],a,d,f;for(a in this.signatureMap)d=this.signatureMap[a],d.a.length!=d.b.length&&(d.a.length&&Array.prototype.push.apply(b,d.a),d.b.length&&
Array.prototype.push.apply(c,d.b));for(d=0;d<b.length;d++)a=b[d],(f=this._find_match(a,c))?(-1!==["attr","tag","text"].indexOf(f.type)&&this.should_report_change(a,f)&&this._difference(f.type,a,f.elem),f.elem._sig=a._sig,c.splice(c.indexOf(f.elem),1)):this._difference("removed",a);for(d=0;d<c.length;d++)this._difference("added",c[d])},_find_match:function(b,c){var a=[],d=!1,f,e,h,l,g;for(e=0;e<c.length;e++)f=c[e],h=b.tagName===f.tagName,l=b._attrStr===f._attrStr,g=b._textStr===f._textStr,2<=h+l+g&&
(f={elem:f},h&&l&&g?(f.type="identical",d=!0):(h||(f.type="tag"),l||(f.type="attr"),g||(f.type="text")),a.push(f));d&&(a=a.filter(function(b){return"identical"==b.type}));return 0<a.length?a.sort(function(a,c){var e=Math.abs(a.elem._index-b._index),d=Math.abs(c.elem._index-b._index);return e<d?-1:d<e?1:0})[0]:null},should_report_change:function(b,a){var d=r(b,this.exclude_changes);if(!d||!d.method.hasOwnProperty(a.type))return!0;if("attr"==a.type)return!this.attr_changes_match(b,a.elem,d.method.attr)},
attr_changes_match:function(a,c,d){var m=[],f=a.attributes.length,e,h,l,g;for(h=0;h<f;h++)if(e=a.attributes[h].name,l=a.getAttribute(e),g=c.getAttribute(e),m.push(e),l!==g&&(e=d[e],void 0===e||e instanceof RegExp&&D(l,e)!==D(g,e)))return!1;f=c.attributes.length;for(h=0;h<f;h++)if(e=c.attributes[h].name,-1==m.indexOf(e)&&-1==d.indexOf(e))return!1;return!0},find_visual_differences:function(b,c){var k=0,m=0,f=0,e,g,r,n,y;void 0===b&&(b=d({stop:this.a,all:!0,exclude:this.exclude_completely}),c=d({stop:this.b,
all:!0,exclude:this.exclude_completely}));for(;null!==b&&null!==c&&25>k;){e=b&&h(b);g=c&&h(c);r=[e,g].sort();n=y=!0;"element"==e&&(m=b._index);"element"==g&&(f=c._index);if(e!==g)if("element"==r[0]&&"text"==r[1])"element"==e?n=!1:y=!1;else{if(-1!=r.indexOf("element")||-1!=r.indexOf("text"))"element"==e||"text"==e?n=!1:y=!1}else if("element"==e){e=b;g=c;var q=e,t=g;r=l.getComputedStyle(q);for(var s=l.getComputedStyle(t),q=q.ownerDocument.URL.split("/").slice(0,3).join("/"),t=t.ownerDocument.URL.split("/").slice(0,
3).join("/"),w=[],x=r.length,u=void 0,v=void 0,v=0;v<x;v++)u=r[v],r.getPropertyValue(u).replace(q,"")!=s.getPropertyValue(u).replace(t,"")&&w.push(u);r=w;s={a:{},b:{}};q=0;t=w=void 0;if(r.length){e=p(e);g=p(g);w={};x=[];v=u=void 0;for(u in e)v=(g[u]||{}).value,e[u].value!=v&&(w[u]=[e[u].value,v]),x.push(u);for(u in g)-1==x.indexOf(u)&&(w[u]=[void 0,g[u].value]);for(t in w)0<r.filter(z(t)).length&&(void 0!==w[t][0]&&(s.a[t]=w[t][0]),void 0!==w[t][1]&&(s.b[t]=w[t][1]),q++)}a(s);e=0!==q?s:null;null!==
e&&(g=this.already_reported_style_change(b,e),null===g?(b._styleAffects=1,b._styleDiff=e,this._difference("style",b,c)):g._styleAffects++)}else{if(e="text"==e&&b.nodeValue!==c.nodeValue)e=c,e=b.nodeValue.replace(C,"")===e.nodeValue.replace(C,"");e&&(e=b,g=c,parentStyle=l.getComputedStyle((e||g).parentNode),parentBlock="block"===parentStyle.getPropertyValue("display"),parentFloat="none"!==parentStyle.getPropertyValue("float"),parentSpaceMatters=parentBlock||parentFloat,textA=null!==e?e.nodeValue:"",
textB=null!==g?g.nodeValue:"",back,forward,e=!1);e&&this._difference("space",b,c)}n&&(b=d({last:b,stop:this.a,all:!0,exclude:this.exclude_completely}));y&&(c=d({last:c,stop:this.b,all:!0,exclude:this.exclude_completely}));k++}b||c?(k=Math.round(50*(m/this.totalA+f/this.totalB)),k=Math.min(99,k)):k=100;return{a:b,b:c,progress:k}},already_reported_style_change:function(a,c){var d=this.differences.style,g=d.length,f,e;for(f=0;f<g;f++)if(e=d[f][0],a._tagSig===e._tagSig&&JSON.stringify(c)===JSON.stringify(e._styleDiff))return e;
return null},_different_spaces:function(a,c){var d=null===a.match(F),g=null===c.match(F),f=null===a.match(G),e=null===c.match(G),h=[];d!=g&&h.push("left");f!=e&&h.push("right");return h},_difference:function(a,c,d){this.differenceCount++;this.differences[a].push([c,d]);if(this.differenceCount>=this.MAX_DIFFERENCES)throw this.stopped_at_max=!0,new w("Max number of differences reached");}};l.Compare=E})(window,window.specificity,window.console.log.bind(window.console));(function(l,n,x,z){function p(a){return String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}function B(a){var d=1!=a.indexOf("?")?"?":"&";return a+d+"_cachebust="+Date.now()}try{document.domain="compare.js"}catch(s){z("FAILed to set document.domain to compare.js - make sure that you've your ServerName is correctly set to compare.js")}var q={init:function(){this.responseActive=!1;this.frameA=this.make_iframe();this.frameB=this.make_iframe();this.parse_dom();
this.settings={};this.events();this.load_input_state()},parse_dom:function(){this.wrapper=document.getElementById("wrapper");this.inA=document.getElementById("page-a");this.inB=document.getElementById("page-b");this.startOverBtn=document.getElementById("do-start-over");this.inBtn=document.getElementById("do-compare");this.settingsDom={toggle:document.getElementById("settings-toggle"),cacheBust:document.getElementById("settings-cache-bust"),exclude:document.getElementById("settings-exclude")};this.response=
document.getElementById("response");this.responseIcon=document.getElementById("response-icon");this.responseSummary=document.getElementById("response-summary");this.responseDetails=document.getElementById("response-details")},process_settings:function(){var a=this.settingsDom.exclude.value.trim();this.settings.cacheBust="yes"===this.settingsDom.cacheBust.value;if(a)try{this.settings.exclude=JSON.parse(a)}catch(d){if(d instanceof SyntaxError)throw this.compare_failed("Failed to parse exclusions JSON block"),
d;}else this.settings.exclude=[]},process_start_over:function(){this.process_comparison(!0)},process_comparison:function(a){var d;""!==this.inA.value&&""!==this.inB.value&&(this.process_settings(),this.toggle_settings(!1),this.inBtn.className="",this.wrapper.setAttribute("class","loading"),this.remove_response(),!0===a?(this.report_progress("Loading pages"),a=this.get_contents(this.frameA,this.inA.value),d=this.get_contents(this.frameB,this.inB.value),l.all([a,d]).then(this.do_compare.bind(this,!0),
this.compare_failed.bind(this)).catch(this.compare_failed.bind(this))):this.do_compare(!1,[this.frameA.contentDocument.body,this.frameB.contentDocument.body]))},response_active:function(){this.responseActive=!0;this.wrapper.setAttribute("class","with-response")},response_inactive:function(){this.responseActive=!1;this.wrapper.removeAttribute("class")},do_compare:function(a,d){var g=this,l=a?2E3:1E3,h;this.report_progress("Calculating DOM differences");setTimeout(function(){try{h=new n({a:d[0],b:d[1],
exclude:g.settings.exclude}),g.compare=h}catch(a){return g.compare_failed(a)}if(h.stopped_at_max)return g.response_active(),g.differences_true(h.differences);g._async_visual()},l)},_async_visual:function(a){var d=this,g,l;void 0===a&&(a={progress:0});if(100>a.progress)setTimeout(function(){try{a=d.compare.find_visual_differences(a.a,a.b),d.report_progress("Calculating visual differences &mdash; "+a.progress+"% complete"),d._async_visual(a)}catch(g){return d.compare_failed(g)}},0);else{g=d.compare.differences;
d.response_active();for(l in g)if(0!==g[l].length)return d.differences_true(g);return d.differences_false()}},remove_response:function(){this.response.removeAttribute("class");this.responseIcon.removeAttribute("class");this.responseSummary.innerHTML="";this.responseDetails.innerHTML=""},differences_true:function(a){var d=0,g=document.createElement("ul"),l,h,p,n,q;for(l in a)for(h=a[l],n=h.length,d+=h.length,q=0;q<n;q++)p=document.createElement("li"),p.innerHTML=this.report_difference(l,h[q]),g.appendChild(p);
this.compare.stopped_at_max&&(d+="+");this.response.setAttribute("class","errors");this.responseIcon.setAttribute("class","issues fa fa-exclamation-circle");this.responseSummary.innerHTML=d+" Difference(s) Found";this.responseDetails.appendChild(g)},differences_false:function(){this.response.setAttribute("class","identical");this.responseIcon.setAttribute("class","fa fa-check-circle");this.responseSummary.innerHTML="Pages are identical";this.responseDetails.innerHTML="We've checked the pages for both DOM and visual differences, and we couldn't find any!"},
report_progress:function(a){this.response.setAttribute("class","loading");this.responseIcon.setAttribute("class","fa fa-spin fa-spinner");this.responseSummary.innerHTML=a;this.responseDetails.innerHTML=""},report_difference:function(a,d){switch(a){case "tag":return'Tag change<code class="a">'+p(d[0]._originalSig)+'</code><code class="b">'+p(d[1]._originalSig)+"</code>";case "attr":return'Attribute change<code class="a">'+p(d[0]._originalSig)+'</code><code class="b">'+p(d[1]._originalSig)+"</code>";
case "removed":return'Element removed<code class="a removed">'+p(d[0]._originalSig)+"</code>";case "added":return'Element added<code class="b">'+p(d[0]._originalSig)+"</code>";case "text":return'Text changed<code class="a">'+p(d[0]._originalSig)+'</code><code class="b">'+p(d[1]._originalSig)+"</code>";case "moved":return'Element Moved<code class="a">'+p(d[0]._originalSig)+"</code>";case "style":var g=d[0]._styleDiff,l=d[0]._styleAffects,h="",n="",q=Object.keys(g.a).length,s=Object.keys(g.b).length,
v;for(v in g.a)1<q&&(h+="\n  "),h+=v+": "+g.a[v]+"; ";for(v in g.b)1<s&&(n+="\n  "),n+=v+": "+g.b[v]+"; ";1<q&&(h+="\n");1<s&&(n+="\n");return"Style change affecting "+l+' element(s)<code class="c">'+p(d[0]._originalSig)+'</code><code class="a">{ '+h+'}</code><code class="b">{ '+n+"}</code>"}},compare_failed:function(a){this.wrapper.setAttribute("class","with-response");this.remove_response();this.response_active();if("object"===typeof a&&"ReachedLimitError"===a.name)return this.differences_true(this.compare.differences);
z("Error: ",a);this.response.setAttribute("class","errors");this.responseIcon.setAttribute("class","issues fa fa-exclamation-circle");this.responseSummary.innerHTML="Comparison failed";this.responseDetails.innerHTML="string"===typeof a?a:void 0!==a.error&&"SecurityError"===a.error.name?"Failed to access <em>"+a.url+"</em> due to cross-origin restrictions":"An unknown error was raised"},make_iframe:function(){var a=document.createElement("iframe");document.getElementById("iframes").appendChild(a);
return a},get_contents:function(a,d){a.src=this.settings.cacheBust?B(d):d;a.removeEventListener("load",a._loadEvent);return new l(function(g,l){a._loadEvent=function(){try{g(a.contentDocument.body)}catch(h){l({error:h,url:d})}};a.addEventListener("load",a._loadEvent)})},process_if_enter:function(a){13==a.keyCode&&this.process_comparison(!0)},toggle_settings:function(a){this.settingsDom.toggle.className=!0===a||!1!==a&&""===this.settingsDom.toggle.className?this.settingsDom.toggle.className+"open":
""},load_input_state:function(){var a;[this.inA,this.inB,this.settingsDom.exclude].forEach(function(d){a=x.getItem("saved-input"+d.id);null!==a&&(d.value=a)},this)},save_input_state:function(){[this.inA,this.inB,this.settingsDom.exclude].forEach(function(a){x.setItem("saved-input"+a.id,a.value)},this)},events:function(){this.inBtn.addEventListener("click",this.process_comparison.bind(this));this.startOverBtn.addEventListener("click",this.process_start_over.bind(this));this.inA.addEventListener("keypress",
this.process_if_enter.bind(this));this.inB.addEventListener("keypress",this.process_if_enter.bind(this));this.settingsDom.toggle.addEventListener("click",this.toggle_settings.bind(this));setInterval(this.save_input_state.bind(this),1E3)}};document.addEventListener("DOMContentLoaded",q.init.bind(q))})(window.Promise,window.Compare,window.localStorage,window.console.log.bind(window.console));
